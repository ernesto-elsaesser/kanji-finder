<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Combos</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" href="game.css#3">
</head>

<body>
<div class="container">
    <h1>Kanji Combos</h1>
    <div id="config">
        <label for="level">JLPT Level: </label>
        <select id="level">
            <option value="N5" selected>N5</option>
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
        </select>
    </div>
    <div class="game-flex">
        <div class="options-col" id="left-col">
            <div class="kanji-row">
                <button id="left0" class="kanji-btn" onclick="choose(event)"></button>
                <button id="left0-reveal" class="reveal-btn left-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
            </div>
            <div class="kanji-row">
                <button id="left1" class="kanji-btn" onclick="choose(event)"></button>
                <button id="left1-reveal" class="reveal-btn left-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
            </div>
            <div class="kanji-row">
                <button id="left2" class="kanji-btn" onclick="choose(event)"></button>
                <button id="left2-reveal" class="reveal-btn left-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
            </div>
            <div class="kanji-row">
                <button id="left3" class="kanji-btn" onclick="choose(event)"></button>
                <button id="left3-reveal" class="reveal-btn left-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
            </div>
        </div>
        <div class="translation-center">
            <div id="reading"></div>
            <a target="_blank" id="word"></a>
            <div id="translation"></div>
            <button id="next" hidden>NEXT</button>
        </div>
        <div class="options-col" id="right-col">
            <div class="kanji-row">
                <button id="right0-reveal" class="reveal-btn right-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
                <button id="right0" class="kanji-btn" onclick="choose(event)"></button>
            </div>
            <div class="kanji-row">
                <button id="right1-reveal" class="reveal-btn right-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
                <button id="right1" class="kanji-btn" onclick="choose(event)"></button>
            </div>
            <div class="kanji-row">
                <button id="right2-reveal" class="reveal-btn right-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
                <button id="right2" class="kanji-btn" onclick="choose(event)"></button>
            </div>
            <div class="kanji-row">
                <button id="right3-reveal" class="reveal-btn right-reveal" type="button"><img src="eye.png" alt="Reveal" class="eye-icon"></button>
                <button id="right3" class="kanji-btn" onclick="choose(event)"></button>
            </div>
        </div>
    </div>
</div>
<script>

const ROWS = [0, 1, 2, 3]
const SUBSETS = {
    "N5": ["N5"],
    "N4": ["N4", "N5"],
    "N3": ["N3", "N4", "N5"],
    "N2": ["N2", "N3", "N4"],
    "N1": ["N1", "N2", "N3"],
}

const levelSelect = document.getElementById("level")
const leftButtons = ROWS.map(i => document.getElementById("left" + i))
const rightButtons = ROWS.map(i => document.getElementById("right" + i))
const leftRevealBtns = ROWS.map(i => document.getElementById("left" + i + "-reveal"))
const rightRevealBtns = ROWS.map(i => document.getElementById("right" + i + "-reveal"))
const readingDiv = document.getElementById("reading")
const wordLink = document.getElementById("word")
const translationDiv = document.getElementById("translation")
const hintsDiv = document.getElementById("hints")
const nextButton = document.getElementById("next")

var jlptKanjis = {}
var jlptWords = {}

var vocab = null
var kanjis = null

var current = null
var leftPick = null
var rightPick = null

async function loadData() {
    let res = await fetch("jlpt.json#2")
    jlptKanjis = await res.json()
    res = await fetch("pairs.json#1")
    jlptWords = await res.json()
    selectLevel()
    levelSelect.onchange = selectLevel
}

function selectLevel() {
    window.location.hash = "#" + levelSelect.value
    const levels = SUBSETS[levelSelect.value]
    vocab = levels.reduce((o, l) => Object.assign(o, jlptWords[l]), {})
    kanjis = levels.reduce((o, l) => Object.assign(o, jlptKanjis[l]), {})
    nextRound()
}

function nextRound() {
    const words = Object.keys(vocab)
    const idx = Math.floor(Math.random() * words.length)
    current = words[idx]
    leftPick = null
    rightPick = null

    readingDiv.textContent = ""
    wordLink.textContent = ""
    translationDiv.innerHTML = vocab[current][1].replace(" (", "<br/>(")
    nextButton.hidden = true

    const decoys = Object.keys(kanjis)
    let options = Array.from(current)
    while (options.length < 8) {
        const didx = Math.floor(Math.random() * decoys.length)
        const decoy = decoys[didx]
        if (!options.includes(decoy)) options.push(decoy)
    }

    const leftOptions = options.slice(5, 8).concat(current[0])
    const rightOptions = options.slice(1, 5)
    shuffle(leftOptions)
    shuffle(rightOptions)

    leftButtons.forEach((b, i) => {
        b.textContent = leftOptions[i]
        b.className = "kanji-btn"
        const revealBtn = leftRevealBtns[i]
        revealBtn.dataset.kanji = leftOptions[i]
        revealBtn.dataset.meaning = kanjis[leftOptions[i]]
        revealBtn.innerHTML = '<img src="eye.png" alt="Reveal" class="eye-icon">'
        revealBtn.className = "reveal-btn left-reveal"
    })
    rightButtons.forEach((b, i) => {
        b.textContent = rightOptions[i]
        b.className = "kanji-btn"
        const revealBtn = rightRevealBtns[i]
        revealBtn.dataset.kanji = rightOptions[i]
        revealBtn.dataset.meaning = kanjis[rightOptions[i]]
        revealBtn.innerHTML = '<img src="eye.png" alt="Reveal" class="eye-icon">'
        revealBtn.className = "reveal-btn right-reveal"
    })
}

function showMeaning(e) {
    const btn = e.currentTarget
    btn.dataset.prevWidth = btn.offsetWidth
    btn.innerText = btn.dataset.meaning
    btn.classList.add('revealed')
}

function hideMeaning(e) {
    const btn = e.currentTarget
    btn.innerHTML = '<img src="eye.png" alt="Reveal" class="eye-icon">'
    btn.classList.remove('revealed')
}

function choose(e) {
    const btn = e.target
    if (btn.id.startsWith("left")) {
        leftButtons.forEach(b => b.className = "kanji-btn")
        leftPick = btn.textContent
    } else {
        rightButtons.forEach(b => b.className = "kanji-btn")
        rightPick = btn.textContent
    }
    btn.classList.add("selected")
    if (leftPick && rightPick) checkAnswer()
}

function checkAnswer() {
    const left = current[0]
    const right = current[1]

    leftButtons.forEach(b => b.className = b.textContent == left ? "correct" : (b.textContent == leftPick ? "incorrect" : ""))
    rightButtons.forEach(b => b.className = b.textContent == right ? "correct" : (b.textContent == rightPick ? "incorrect" : ""))

    readingDiv.textContent = vocab[current][0]
    wordLink.textContent = current
    wordLink.href = "https://jisho.org/search/" + current

    nextButton.hidden = false
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[a[i], a[j]] = [a[j], a[i]]
    }
    return a
}

nextButton.addEventListener('click', nextRound)

leftRevealBtns.concat(rightRevealBtns).forEach(btn => {
    btn.addEventListener('pointerenter', showMeaning)
    btn.addEventListener('pointerleave', hideMeaning)
})

const level = window.location.hash.slice(1)
if (level) levelSelect.value = level

loadData()

</script>

</body>

</html>