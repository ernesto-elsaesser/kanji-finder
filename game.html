<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Combos</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" href="game.css?4">
</head>

<body>
<div class="container">
    <h1>Kanji Combos</h1>
    <div id="config">
        <label for="level">JLPT Level: </label>
        <select id="level">
            <option value="N5" selected>N5</option>
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
        </select>
    </div>
    <div class="game-flex">
        <div class="options-col" id="left-options"></div>
        <div class="translation-center">
            <div id="feedback"></div>
            <div id="reading"></div>
            <div id="word"></div>
            <div id="translation"></div>
            <button id="next" hidden>NEXT</button>
        </div>
        <div class="options-col" id="right-options"></div>
    </div>
</div>
<script>

const SUBSETS = {
    "N5": ["N5"],
    "N4": ["N4", "N5"],
    "N3": ["N3", "N4", "N5"],
    "N2": ["N2", "N3", "N4"],
    "N1": ["N1", "N2", "N3"],
}

const levelSelect = document.getElementById('level')
const readingDiv = document.getElementById('reading')
const wordDiv = document.getElementById('word')
const translationDiv = document.getElementById('translation')
const leftOptionsDiv = document.getElementById('left-options')
const rightOptionsDiv = document.getElementById('right-options')
const feedbackDiv = document.getElementById('feedback')
const nextBtn = document.getElementById('next')

var pairs = {}
var subset = null
var allWords = null
var allKanji = null

var current = null
var leftPick = null
var rightPick = null

async function load() {
    const res = await fetch("pairs.json?3")
    pairs = await res.json()
    select()
    levelSelect.onchange = select
}

function select() {
    window.location.hash = "#" + levelSelect.value
    const levels = levelSelect.value.split(",")
    subset = {}
    const wordSet = new Set()
    const kanjiSet = new Set()
    for (let level of levels) {
        const levelPairs = pairs[level]
        for (let pair in levelPairs) {
            subset[pair] = levelPairs[pair]
            wordSet.add(pair)
            Array.from(pair).forEach(k => kanjiSet.add(k))
        }
    }
    allWords = Array.from(wordSet)
    allKanji = Array.from(kanjiSet)
    nextRound()
}

function nextRound() {
    const idx = Math.floor(Math.random() * allWords.length)
    current = allWords[idx]
    leftPick = null
    rightPick = null

    feedbackDiv.textContent = ''
    readingDiv.textContent = ''
    wordDiv.textContent = ''
    translationDiv.innerHTML = subset[current][1].replace(" (", "<br/>(")
    nextBtn.hidden = true

    let options = Array.from(current)
    while (options.length < 8) {
        const didx = Math.floor(Math.random() * allWords.length)
        const decoy = allWords[didx]
        const valid = Array.from(decoy).filter(k => !options.includes(k))
        valid.forEach(k => options.push(k))
    }

    const leftOptions = options.slice(5, 8).concat(current[0])
    const rightOptions = options.slice(1, 5)
    shuffle(leftOptions)
    shuffle(rightOptions)

    leftOptionsDiv.innerHTML = ''
    rightOptionsDiv.innerHTML = ''
    leftOptions.forEach(kanji => {
        const btn = document.createElement('div')
        btn.className = 'kanji-option'
        btn.textContent = kanji
        btn.onclick = () => selectKanji('left', kanji, btn)
        leftOptionsDiv.appendChild(btn)
    })
    rightOptions.forEach(kanji => {
        const btn = document.createElement('div')
        btn.className = 'kanji-option'
        btn.textContent = kanji
        btn.onclick = () => selectKanji('right', kanji, btn)
        rightOptionsDiv.appendChild(btn)
    })
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[a[i], a[j]] = [a[j], a[i]]
    }
    return a
}

function selectKanji(side, kanji, btn) {
    if (side === 'left') {
        leftPick = kanji
    } else {
        rightPick = kanji
    }
    btn.classList.add('selected')
    if (leftPick && rightPick) {
        checkAnswer()
    }
}

function checkAnswer() {
    const left = current[0]
    const right = current[1]
    Array.from(leftOptionsDiv.children).forEach(el => {
        if (el.textContent === left) {
            el.classList.add('correct')
        } else if (el.textContent === leftPick) {
            el.classList.add('incorrect')
        }
    })
    Array.from(rightOptionsDiv.children).forEach(el => {
        if (el.textContent === right) {
            el.classList.add('correct')
        } else if (el.textContent === rightPick) {
            el.classList.add('incorrect')
        }
    })

    if (leftPick === left && rightPick === right) {
        feedbackDiv.textContent = 'Correct!'
    } else {
        feedbackDiv.textContent = 'Wrong!'
    }

    readingDiv.textContent = subset[current][0]
    wordDiv.textContent = current

    nextBtn.hidden = false
}

nextBtn.onclick = nextRound

const level = window.location.hash.slice(1)
if (level) levelSelect.value = level

load()

</script>

</body>

</html>