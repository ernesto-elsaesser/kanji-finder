<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Combos</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" href="game.css">
</head>

<body>
<div class="container">
    <h1>Kanji Combos</h1>
    <div style="text-align:center; margin-bottom:1.2em;">
        <label for="level">JLPT Level: </label>
        <select id="level">
            <option value="N5" selected>JLPT N5</option>
            <option value="N4">JLPT N4</option>
            <option value="N3">JLPT N3</option>
            <option value="N2">JLPT N2</option>
            <option value="N1">JLPT N1</option>
        </select>
    </div>
    <div class="game-flex">
        <div class="options-col" id="left-options"></div>
        <div class="translation-center">
            <div class="jukugo-word" id="jukugo-word"></div>
            <div class="translation" id="translation"></div>
        </div>
        <div class="options-col" id="right-options"></div>
    </div>
    <div class="feedback" id="feedback"></div>
    <button class="next-btn" id="next-btn" style="display:none;">Next</button>
</div>
<script>

const levelSelect = document.getElementById('level')
const translationDiv = document.getElementById('translation')
const leftOptionsDiv = document.getElementById('left-options')
const rightOptionsDiv = document.getElementById('right-options')
const feedbackDiv = document.getElementById('feedback')
const nextBtn = document.getElementById('next-btn')

var jouyou = {}
var pairs = {}
var subset = {}

var current = null
var leftPick = null
var rightPick = null

async function load() {
    const res1 = await fetch("jouyou.json?1")
    jouyou = await res1.json()
    const res2 = await fetch("pairs.json?1")
    pairs = await res2.json()
    select()
    levelSelect.onchange = select
}

function select() {
    const levels = levelSelect.value.split(",")
    subset = {}
    levels.forEach((l) => Object.assign(subset, pairs[l]))
    start()
}

function start() {
    // Pick a random jukugo from subset
    const keys = Object.keys(subset)
    if (!keys.length) {
        translationDiv.textContent = 'No data for this level.'
        leftOptionsDiv.innerHTML = ''
        rightOptionsDiv.innerHTML = ''
        feedbackDiv.textContent = ''
        nextBtn.style.display = 'none'
        return
    }
    const idx = Math.floor(Math.random() * keys.length)
    const jukugo = keys[idx]
    const meaning = subset[jukugo]
    current = { jukugo, meaning }
    leftPick = null
    rightPick = null
    renderRound()
}

function renderRound() {
    document.getElementById('jukugo-word').textContent = ''
    translationDiv.textContent = current.meaning
    feedbackDiv.textContent = ''
    nextBtn.style.display = 'none'
    // Get left and right kanji
    const left = current.jukugo[0]
    const right = current.jukugo[1]
    // Get 3 random distractors for each side
    const kanjiList = Object.keys(jouyou)
    function getDistractors(correct, count) {
        const arr = kanjiList.filter(k => k !== correct)
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1))
            ;[arr[i], arr[j]] = [arr[j], arr[i]]
        }
        return arr.slice(0, count)
    }
    const leftOptions = getDistractors(left, 3).concat(left)
    const rightOptions = getDistractors(right, 3).concat(right)
    // Shuffle options
    function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1))
            ;[a[i], a[j]] = [a[j], a[i]]
        }
        return a
    }
    shuffle(leftOptions)
    shuffle(rightOptions)
    // Render options
    leftOptionsDiv.innerHTML = ''
    rightOptionsDiv.innerHTML = ''
    leftOptions.forEach(kanji => {
        const btn = document.createElement('div')
        btn.className = 'kanji-option'
        btn.textContent = kanji
        btn.onclick = () => selectKanji('left', kanji, btn)
        leftOptionsDiv.appendChild(btn)
    })
    rightOptions.forEach(kanji => {
        const btn = document.createElement('div')
        btn.className = 'kanji-option'
        btn.textContent = kanji
        btn.onclick = () => selectKanji('right', kanji, btn)
        rightOptionsDiv.appendChild(btn)
    })
}

function selectKanji(side, kanji, btn) {
    if (side === 'left') {
        leftPick = kanji
        Array.from(leftOptionsDiv.children).forEach(el => el.classList.remove('selected'))
        btn.classList.add('selected')
    } else {
        rightPick = kanji
        Array.from(rightOptionsDiv.children).forEach(el => el.classList.remove('selected'))
        btn.classList.add('selected')
    }
    if (leftPick && rightPick) {
        checkAnswer()
    }
}

function checkAnswer() {
    const left = current.jukugo[0]
    const right = current.jukugo[1]
    let leftCorrect = false, rightCorrect = false
    Array.from(leftOptionsDiv.children).forEach(el => {
        if (el.textContent === left) {
            if (leftPick === left) {
                el.classList.add('correct')
                leftCorrect = true
            } else {
                el.classList.add('correct')
            }
        } else if (el.textContent === leftPick) {
            el.classList.add('incorrect')
        }
    })
    Array.from(rightOptionsDiv.children).forEach(el => {
        if (el.textContent === right) {
            if (rightPick === right) {
                el.classList.add('correct')
                rightCorrect = true
            } else {
                el.classList.add('correct')
            }
        } else if (el.textContent === rightPick) {
            el.classList.add('incorrect')
        }
    })
    if (leftPick === left && rightPick === right) {
        document.getElementById('jukugo-word').textContent = `${left}${right}`
        translationDiv.textContent = current.meaning
        feedbackDiv.textContent = 'Correct! '
    } else {
        feedbackDiv.textContent = `Incorrect. The answer is ${left}${right}`
    }
    nextBtn.style.display = 'block'
}

nextBtn.onclick = start

load()

</script>

</body>

</html>