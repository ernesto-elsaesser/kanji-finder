<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Finder</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            font-size: 20px;
        }
        span {
            font-size: 22px;
        }
        input {
            margin-bottom: 10px;
        }
        button {
            font-size: 14px;
        }
        .selected {
            background-color: coral;
        }
    </style>
</head>

<body>
<div id="radical-list"></div>
<hr/>
<ul id="kanji-list"></ul>
<button id="more" onclick="filter(false)" hidden>More</button>
<hr/>
<input id="query" type="text"/><br>
<button onclick="delAll()">CLEAR</button> <button onclick="copy()">COPY</button> <button onclick="lookup()">LOOKUP</button> <button onclick="jisho()">JISHO</button>
<ul id="entry-list"></ul>

<script>

const RADICALS = {
    "🔄": "冂凵匚囗厂广疒尸戸弋戈辶門虍",
    "⬆️": "亠冖宀𠆢癶⺾罒⺌竹雨",
    "⬅️": "冫氵⺅彳忄扌犭礻衤⻖木禾石糸言舟虫足食車金酉魚弓爿",
    "1️⃣": "一｜丶ノ乙亅",
    "2️⃣": "二人儿ハ几刀刂力勹匕十卜卩厶又マ九:入ユ乃",
    "3️⃣": "口土士工干夂夕大女子寸小山巛已巾幺廾ヨ彡⻏:尢屮川彑也亡及久廴",
    "4️⃣": "⺹心手攵斤方日月欠止歹殳比氏水火灬爪牛犬王勿:支元井并文父爻无尤毛屯五曰片巴毋斗气",
    "5️⃣": "甘用田疋白皿目矢示禸穴立冊:生世巨玄母矛牙皮瓦",
    "6️⃣": "米缶羊羽耳聿自至臼艮衣臣西:色舌血行瓜肉耒而舛",
    "7️⃣": "見豆豕貝辛釆:谷豸角走身赤辰邑麦",
    "8️⃣": "里長隹革:青免斉非奄岡隶",
    "9️⃣": "音頁品:面風首韭香飛",
    "🔟": "馬:鬥鬼骨韋鬲竜髟鬯高",
    "*️⃣": "鳥:亀黒麻黄鹿鹵歯無黍黹黽鼠鼓鼎鼻齊滴龠",
}

var krad = {}
var edict = {}

var components = []

let radicalList = document.getElementById("radical-list")
let kanjiList = document.getElementById("kanji-list")
let moreButton = document.getElementById("more")
let query = document.getElementById("query")
let entryList = document.getElementById("entry-list")

function init() {
    fetch("krad.json#2").then(r => r.json()).then(d => krad = d)
    fetch("edict.json#1").then(r => r.json()).then(d => edict = d)
    buildButtons()
}

function buildButtons() {
    radicalList.innerHTML = ""
    for (let subset in RADICALS) {
        const group = document.createElement("div")
        group.textContent = subset + " "
        let rare = false
        for (let radical of RADICALS[subset]) {
            if (radical == ":") {
                rare = true
                continue
            }
            const btn = document.createElement("span")
            btn.textContent = radical
            if (rare) btn.style.color = "grey"
            btn.onclick = () => {
                if (btn.classList.contains("selected")) {
                    components = components.filter(c => c != radical)
                    btn.classList.remove("selected")
                } else {
                    components.push(radical)
                    btn.classList.add("selected")
                }
                filter(true)
            }
            group.appendChild(btn)
        }
        radicalList.appendChild(group)
    }
}

function filter(jouyouOnly) {

    kanjiList.innerHTML = ""

    if (components.length == 0) return

    let html = ""
    for (let entry of krad) {
        if ((entry.length == 2) && jouyouOnly) continue
        const decomp = entry[1]
        let match = true
        for (let radical of components) {
            if (!decomp.includes(radical)) {
                match = false
                break
            }
        }
        if (!match) continue
        let kanji = entry[0]
        let meanings = entry[2] || ""
        html += "<li onclick=\"query.value += '" + kanji + "'\">" + kanji + '（' + decomp + '）' + meanings.toUpperCase() + "</li>"
    }

    kanjiList.innerHTML = html
    moreButton.hidden = !jouyouOnly
}

function copy() {

    navigator.clipboard.writeText(query.value);
}

function delAll() {

    query.value = ""
    lookup()
}

function lookup() {

    entryList.innerHTML = ""

    if (query.value.length == 0) return

    let html = ""
    Object.entries(edict).forEach(([key, value]) => {
        if (key.includes(query.value)) {
            const entry = "[" + value[0][0] + "] - " + value[0][1][1]
            html += "<li><b>" + key + "</b> " + entry + "</li>"
        }
    })

    if (html == "") entryList.innerHTML = "<li>no matches</li>"
    else entryList.innerHTML = html
}

function jisho() {

    open("https://jisho.org/search/" + query.value, "_blank")
}

init()

</script>

</body>

</html>