<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Quiz</title>
</head>

<body>
<div class="options-col" id="left-options"></div>
<div class="options-col" id="right-options"></div>
<div class="translation-center">
    <div id="feedback"></div>
    <div id="reading"></div>
    <div id="word"></div>
    <div id="translation"></div>
    <button id="next" onclick="nextRound()" hidden>NEXT</button>
</div>
<script>

const readingDiv = document.getElementById('reading')
const wordLink = document.getElementById('word')
const translationDiv = document.getElementById('translation')
const leftOptionsDiv = document.getElementById('left-options')
const rightOptionsDiv = document.getElementById('right-options')
const feedbackDiv = document.getElementById('feedback')
const nextBtn = document.getElementById('next')

var kanjiInfos = {}
var twoKanjiWords = {}

var currentWord = null
var leftPick = null
var rightPick = null

async function loadDatasets() {
    let res = await fetch("kanjis.json")
    kanjiInfos = await res.json()
    res = await fetch("words.json")
    twoKanjiWords = await res.json()
    nextRound()
}

function nextRound() {
    const words = Object.keys(twoKanjiWords)
    const wordIndex = Math.floor(Math.random() * words.length)
    currentWord = words[wordIndex]
    leftPick = null
    rightPick = null

    feedbackDiv.textContent = ''
    readingDiv.textContent = ''
    wordLink.textContent = ''
    translationDiv.innerHTML = twoKanjiWords[currentWord]
    nextBtn.hidden = true

    let decoys = Object.keys(kanjiInfos)
    let options = Array.from(currentWord)
    while (options.length < 8) {
        const decoyIndex = Math.floor(Math.random() * decoys.length)
        const decoy = decoys[decoyIndex]
        if (!options.includes(decoy)) options.push(decoy)
    }

    const leftIndices = [0, 2, 4, 6]
    const rightOptions = [1, 3, 5, 7]
    shuffle(leftIndices)
    shuffle(rightOptions)

    leftOptionsDiv.innerHTML = ''
    leftIndices.forEach(i => {
        leftOptionsDiv.appendChild(createButton(options[i], false))
    })

    rightOptionsDiv.innerHTML = ''
    rightOptions.forEach(i => {
        rightOptionsDiv.appendChild(createButton(options[i], true))
    })
}

function createButton(kanji, right) {
    const button = document.createElement('button')
    button.textContent = kanji
    const info = kanjiInfos[kanji]
    const hint = info["readings"][0] + " = " + info["meanings"]
    button.title = hint
    button.onclick = function() {
        button.style.borderColor = "blue"
        if (right) rightPick = kanji
        else leftPick = kanji
        if (leftPick && rightPick) checkAnswer()
    }
    return button
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[a[i], a[j]] = [a[j], a[i]]
    }
    return a
}

function checkAnswer() {
    const left = currentWord[0]
    const right = currentWord[1]
    Array.from(leftOptionsDiv.children).forEach(button => {
        if (button.textContent === left) {
            button.style.borderColor = "green"
        } else if (button.textContent === leftPick) {
            button.style.borderColor = "red"
        }
    })
    Array.from(rightOptionsDiv.children).forEach(button => {
        if (button.textContent === right) {
            button.style.borderColor = "green"
        } else if (button.textContent === rightPick) {
            button.style.borderColor = "red"
        }
    })

    if (leftPick === left && rightPick === right) {
        feedbackDiv.textContent = 'Correct!'
    } else {
        feedbackDiv.textContent = 'Wrong!'
    }

    readingDiv.textContent = subset[currentWord][0]
    wordLink.textContent = currentWord
    nextBtn.hidden = false
}

loadDatasets()

</script>

</body>
</html>