<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kanji Combos</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link rel="stylesheet" href="style.css#1">
</head>

<body>
<div class="container">
    <h1>Kanji Combos</h1>
    <div id="config">
        <label for="level">JLPT Level: </label>
        <select id="level">
            <option value="N5" selected>N5</option>
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
        </select>
    </div>
    <div class="game-flex">
        <div class="options-col" id="left-col"></div>
            <div class="translation-center">
                <div id="hint"></div>
                <div id="reading"></div>
                <a target="_blank" id="word"></a>
                <div id="translation"></div>
                <button id="next" hidden>NEXT</button>
            </div>
        <div class="options-col" id="right-col"></div>
    </div>
</div>
<script>

const ROWS = [0, 1, 2, 3]
const SUBSETS = {
    "N5": ["N5"],
    "N4": ["N4", "N5"],
    "N3": ["N3", "N4", "N5"],
    "N2": ["N2", "N3", "N4"],
    "N1": ["N1", "N2", "N3"],
}

const levelSelect = document.getElementById("level")
const leftCol = document.getElementById("left-col")
const rightCol = document.getElementById("right-col")
const columns = {"l": leftCol, "r": rightCol}
const hintDiv = document.getElementById("hint")
const readingDiv = document.getElementById("reading")
const wordLink = document.getElementById("word")
const translationDiv = document.getElementById("translation")
const hintsDiv = document.getElementById("hints")
const nextButton = document.getElementById("next")

var jlptKanjis = {}
var jlptWords = {}

var vocab = null
var kanjis = null

var targets = {}
var options = {}
var picks = {}
var hint = null

async function loadData() {
    let res = await fetch("jlpt.json#2")
    jlptKanjis = await res.json()
    res = await fetch("pairs.json#1")
    jlptWords = await res.json()
    selectLevel()
    levelSelect.onchange = selectLevel
}

function selectLevel() {
    window.location.hash = "#" + levelSelect.value
    const levels = SUBSETS[levelSelect.value]
    vocab = levels.reduce((o, l) => Object.assign(o, jlptWords[l]), {})
    kanjis = levels.reduce((o, l) => Object.assign(o, jlptKanjis[l]), {})
    nextRound()
}

function nextRound() {
    const words = Object.keys(vocab)
    const idx = Math.floor(Math.random() * words.length)
    const word = words[idx]

    targets = {"l": word[0], "r": word[1]}
    picks = {"l": null, "r": null}
    hint = null

    const decoys = Object.keys(kanjis)
    let pool = Array.from(word)
    while (pool.length < 8) {
        const didx = Math.floor(Math.random() * decoys.length)
        const decoy = decoys[didx]
        if (!pool.includes(decoy)) pool.push(decoy)
    }

    options["l"] = pool.slice(5, 8).concat(word[0])
    options["r"] = pool.slice(1, 5)
    shuffle(options["l"])
    shuffle(options["r"])

    update()
}

function showHint(kanji) {
    hint = kanjis[kanji]
    update()
}

function update() {
    const reveal = picks["l"] && picks["r"]

    updateColumn("l", reveal)
    updateColumn("r", reveal)

    const word = targets["l"] + targets["r"]

    hintDiv.textContent = hint || ""

    readingDiv.textContent = reveal ? vocab[word][0] : ""
    wordLink.textContent = reveal ? word : ""
    wordLink.href = reveal ? "https://jisho.org/search/" + word : ""

    translationDiv.innerHTML = vocab[word][1].replace(" (", "<br/>(")

    nextButton.hidden = !reveal
}

function updateColumn(side, reveal) {

    columns[side].innerHTML = ""

    options[side].forEach(kanji => {

        const row = document.createElement("div")
        row.className = "kanji-row"

        const button = document.createElement("button")
        button.innerText = kanji
        button.className = "kanji-btn"
        if (reveal) {
            if (kanji == targets[side]) button.classList.add("correct")
            else if (kanji == picks[side]) button.classList.add("incorrect")
        }
        else if (kanji == picks[side]) button.classList.add("selected")
        
        button.addEventListener('click', () => {
            picks[side] = kanji
            update()
        })

        const toggle = document.createElement("button")
        toggle.className = "hint-btn"

        toggle.addEventListener('click', () => showHint(kanji))

        if (side == "r") row.appendChild(toggle)
        row.appendChild(button)
        if (side == "l") row.appendChild(toggle)

        columns[side].appendChild(row)
    })
}

function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        ;[a[i], a[j]] = [a[j], a[i]]
    }
    return a
}

nextButton.addEventListener('click', nextRound)

const level = window.location.hash.slice(1)
if (level) levelSelect.value = level

loadData()

</script>

</body>

</html>